<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sociocool!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            touch-action: manipulation;
            background-color: #f3f4f6;
            overflow-x: hidden;
        }
        .screen {
            display: none;
            min-height: 100vh;
            animation: fadeIn 0.3s ease-in-out;
        }
        .screen.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-bounce:active {
            transform: scale(0.95);
        }
        .level-node {
            transition: all 0.3s;
        }
        .level-node.locked {
            filter: grayscale(100%);
            opacity: 0.6;
            pointer-events: none;
        }
        /* Confetti animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: fall linear forwards;
            z-index: 100;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }
        
        /* Custom Themes */
        .theme-blue { --bg-primary: #3b82f6; --bg-secondary: #dbeafe; }
        .theme-purple { --bg-primary: #8b5cf6; --bg-secondary: #ede9fe; }
        .theme-green { --bg-primary: #10b981; --bg-secondary: #d1fae5; }
        .theme-orange { --bg-primary: #f97316; --bg-secondary: #ffedd5; }
    </style>
</head>
<body class="theme-blue bg-[var(--bg-secondary)] text-gray-800 transition-colors duration-500">

    <!-- HEADER / HUD -->
    <div class="fixed top-0 w-full bg-white shadow-lg z-50 p-2 flex justify-between items-center h-16">
        <div class="flex items-center gap-2">
            <i class="fas fa-heart text-red-500 text-xl animate-pulse"></i>
            <span id="livesDisplay" class="font-bold text-xl">3</span>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-1 bg-yellow-100 px-3 py-1 rounded-full">
                <i class="fas fa-coins text-yellow-500"></i>
                <span id="coinsDisplay" class="font-bold text-sm">0</span>
            </div>
            <div class="flex items-center gap-1 bg-purple-100 px-3 py-1 rounded-full">
                <i class="fas fa-gem text-purple-500"></i>
                <span id="gemsDisplay" class="font-bold text-sm">0</span>
            </div>
            <div class="flex items-center gap-1 bg-orange-100 px-3 py-1 rounded-full">
                <i class="fas fa-fire text-orange-500"></i>
                <span id="streakDisplay" class="font-bold text-sm">0</span>
            </div>
        </div>

        <button onclick="toggleMenu()" class="text-gray-600 p-2">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </div>

    <!-- MAIN CONTENT CONTAINER -->
    <div id="app" class="pt-20 pb-24 px-4 max-w-md mx-auto relative">

        <!-- SCREEN: MAP (HOME) -->
        <div id="screen-map" class="screen active">
            <h1 class="text-3xl font-bold text-center mb-2 text-[var(--bg-primary)]">Sociocool World</h1>
            <p class="text-center text-gray-500 text-sm mb-6">Master social skills to unlock theorists!</p>
            
            <div class="flex flex-col items-center space-y-8 relative" id="levelMap">
                <!-- Levels will be injected here by JS -->
            </div>
        </div>

        <!-- SCREEN: QUIZ -->
        <div id="screen-quiz" class="screen">
            <div class="flex justify-between items-center mb-4">
                <button onclick="quitLevel()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i> Quit</button>
                <div class="text-sm font-bold text-[var(--bg-primary)]" id="levelProgress">1/5</div>
            </div>

            <!-- Lifelines -->
            <div class="flex justify-center gap-4 mb-6">
                <button onclick="useLifeline('5050')" id="btn-5050" class="flex flex-col items-center gap-1 text-xs font-bold text-blue-600 bg-blue-100 p-2 rounded-lg w-16 opacity-100 btn-bounce">
                    <i class="fas fa-cut"></i> 50/50
                    <span class="text-[10px] bg-white px-1 rounded">50ðŸª™</span>
                </button>
                <button onclick="useLifeline('skip')" id="btn-skip" class="flex flex-col items-center gap-1 text-xs font-bold text-green-600 bg-green-100 p-2 rounded-lg w-16 opacity-100 btn-bounce">
                    <i class="fas fa-forward"></i> Skip
                    <span class="text-[10px] bg-white px-1 rounded">100ðŸª™</span>
                </button>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-md border-b-4 border-gray-200 mb-6 relative overflow-hidden">
                <div id="questionTag" class="absolute top-0 right-0 bg-[var(--bg-primary)] text-white text-xs px-2 py-1 rounded-bl-lg">Greeting</div>
                <h2 id="questionText" class="text-xl font-bold text-gray-800 leading-relaxed">Loading...</h2>
            </div>

            <div id="optionsContainer" class="space-y-3">
                <!-- Options injected here -->
            </div>
        </div>

        <!-- SCREEN: LIBRARY (Theorists & Cool People) -->
        <div id="screen-library" class="screen">
            <div class="flex justify-center gap-4 mb-6">
                <button onclick="switchLibraryTab('theorists')" class="px-4 py-2 bg-[var(--bg-primary)] text-white rounded-full font-bold shadow-md">Theorists</button>
                <button onclick="switchLibraryTab('people')" class="px-4 py-2 bg-white text-gray-600 rounded-full font-bold shadow-sm">Cool People</button>
            </div>

            <div id="tab-theorists" class="grid grid-cols-2 gap-4">
                <!-- Theorists injected here -->
            </div>
            
            <div id="tab-people" class="hidden grid grid-cols-2 gap-4">
                <!-- Cool People injected here -->
            </div>
        </div>

        <!-- SCREEN: DIARY -->
        <div id="screen-diary" class="screen">
            <h2 class="text-2xl font-bold text-center mb-4 text-purple-600">My Social Diary</h2>
            <div class="bg-purple-100 p-4 rounded-xl mb-4 text-sm text-purple-800">
                <i class="fas fa-info-circle mr-2"></i>Review situations you've mastered. Click "I did this!" if you used the skill in real life to earn Gems!
            </div>
            <div id="diaryEntries" class="space-y-4">
                <!-- Diary entries -->
            </div>
        </div>

        <!-- SCREEN: SHOP -->
        <div id="screen-shop" class="screen">
            <h2 class="text-2xl font-bold text-center mb-2 text-orange-500">Shop</h2>
            <div class="text-center mb-6 text-gray-500 text-sm">Spend Gems on style & Coins on boosters</div>

            <h3 class="font-bold text-lg mb-2 pl-2">App Themes (20 Gems)</h3>
            <div class="flex gap-3 overflow-x-auto pb-4 px-2 mb-6">
                <div onclick="buyTheme('theme-blue')" class="flex-shrink-0 w-20 h-20 bg-blue-500 rounded-xl shadow-lg cursor-pointer transform hover:scale-105 border-4 border-white"></div>
                <div onclick="buyTheme('theme-purple')" class="flex-shrink-0 w-20 h-20 bg-purple-500 rounded-xl shadow-lg cursor-pointer transform hover:scale-105 border-4 border-white"></div>
                <div onclick="buyTheme('theme-green')" class="flex-shrink-0 w-20 h-20 bg-green-500 rounded-xl shadow-lg cursor-pointer transform hover:scale-105 border-4 border-white"></div>
                <div onclick="buyTheme('theme-orange')" class="flex-shrink-0 w-20 h-20 bg-orange-500 rounded-xl shadow-lg cursor-pointer transform hover:scale-105 border-4 border-white"></div>
            </div>

            <h3 class="font-bold text-lg mb-2 pl-2">Boosters (Coins)</h3>
            <div class="bg-white p-4 rounded-xl shadow-sm border mb-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-red-100 p-2 rounded-lg"><i class="fas fa-heart text-red-500"></i></div>
                    <div>
                        <div class="font-bold">Extra Life</div>
                        <div class="text-xs text-gray-500">Recover 1 heart</div>
                    </div>
                </div>
                <button onclick="buyBooster('life', 200)" class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-lg font-bold text-sm shadow-sm btn-bounce">200ðŸª™</button>
            </div>
             <div class="bg-white p-4 rounded-xl shadow-sm border mb-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-100 p-2 rounded-lg"><i class="fas fa-snowflake text-blue-500"></i></div>
                    <div>
                        <div class="font-bold">Streak Freeze</div>
                        <div class="text-xs text-gray-500">Save your streak</div>
                    </div>
                </div>
                <button onclick="buyBooster('freeze', 500)" class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-lg font-bold text-sm shadow-sm btn-bounce">500ðŸª™</button>
            </div>
            
            <h3 class="font-bold text-lg mb-2 pl-2 mt-6">Sociocool People (300 Gems)</h3>
            <div id="shopPeopleContainer" class="space-y-3">
                <!-- Shop items for people -->
            </div>
        </div>

    </div>

    <!-- BOTTOM NAVIGATION -->
    <div class="fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around items-center h-16 pb-safe z-40">
        <button onclick="showScreen('screen-map')" class="nav-btn text-[var(--bg-primary)] flex flex-col items-center w-full">
            <i class="fas fa-map text-xl mb-1"></i>
            <span class="text-[10px]">Map</span>
        </button>
        <button onclick="showScreen('screen-library')" class="nav-btn text-gray-400 flex flex-col items-center w-full hover:text-[var(--bg-primary)]">
            <i class="fas fa-book-open text-xl mb-1"></i>
            <span class="text-[10px]">Library</span>
        </button>
        <button onclick="showScreen('screen-diary')" class="nav-btn text-gray-400 flex flex-col items-center w-full hover:text-[var(--bg-primary)]">
            <i class="fas fa-book-journal-whills text-xl mb-1"></i>
            <span class="text-[10px]">Diary</span>
        </button>
        <button onclick="showScreen('screen-shop')" class="nav-btn text-gray-400 flex flex-col items-center w-full hover:text-[var(--bg-primary)]">
            <i class="fas fa-store text-xl mb-1"></i>
            <span class="text-[10px]">Shop</span>
        </button>
    </div>

    <!-- MODAL (Feedback) -->
    <div id="feedbackModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all scale-100">
            <div id="feedbackIcon" class="w-16 h-16 rounded-full mx-auto flex items-center justify-center text-3xl mb-4 shadow-lg"></div>
            <h3 id="feedbackTitle" class="text-2xl font-bold text-center mb-2">Title</h3>
            <p id="feedbackText" class="text-gray-600 text-center mb-4">Explanation goes here.</p>
            <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-500 italic mb-6 border-l-4 border-gray-300">
                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i><span id="feedbackContext">Context tip.</span>
            </div>
            <button onclick="nextQuestion()" class="w-full bg-[var(--bg-primary)] text-white py-3 rounded-xl font-bold text-lg shadow-lg btn-bounce">Continue</button>
        </div>
    </div>
    
    <!-- MODAL (Theorist Unlock) -->
    <div id="unlockModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 text-center">
            <h2 class="text-xl font-bold text-orange-500 mb-2">NEW THEORIST UNLOCKED!</h2>
            <img id="unlockImage" src="" class="w-24 h-24 mx-auto rounded-full border-4 border-orange-300 mb-4 bg-gray-200 object-cover">
            <h3 id="unlockName" class="text-2xl font-bold text-gray-800">Name</h3>
            <p id="unlockConcept" class="text-sm font-bold text-gray-600 mb-4">Concept</p>
            <p id="unlockDesc" class="text-xs text-gray-500 mb-6">Description</p>
            <button onclick="closeUnlockModal()" class="w-full bg-orange-500 text-white py-2 rounded-xl font-bold">Awesome!</button>
        </div>
    </div>

    <script>
        /* --- GAME DATA --- */
        
        // Theorists to collect
        const theorists = [
            { id: 'goffman', name: 'Erving Goffman', concept: 'Dramaturgy', desc: 'Life is like a stage play. We act differently depending on who is watching (audience). Front stage is our public behavior, back stage is how we relax.', level: 1 },
            { id: 'bourdieu', name: 'Pierre Bourdieu', concept: 'Habitus', desc: 'Our habits and skills are shaped by where we grew up. Social norms feel "natural" but are actually learned.', level: 2 },
            { id: 'douglas', name: 'Mary Douglas', concept: 'Matter Out of Place', desc: 'Dirt is just "matter out of place." Rules about cleanliness and behavior help societies create order and feel safe.', level: 3 },
            { id: 'durkheim', name: 'Ã‰mile Durkheim', concept: 'Social Facts', desc: 'Social norms are real things that exist outside of us. They push us to act in certain ways, like an invisible current.', level: 4 },
            { id: 'mead', name: 'George Herbert Mead', concept: 'The Generalized Other', desc: 'When we act, we imagine what "society" expects of us. This helps us fit in even when no one specific is watching.', level: 5 }
        ];

        // Cool People (Neurodiverse implicit)
        const coolPeopleData = [
            { id: 'alan', name: 'Alan Turing', desc: 'A brilliant mathematician who cracked codes. He found social rules puzzling but used logic to solve world-changing problems.', cost: 300, icon: 'fas fa-laptop-code' },
            { id: 'greta', name: 'Greta Thunberg', desc: 'She speaks directly and honestly about climate change. Her intense focus helps her see problems others ignore.', cost: 300, icon: 'fas fa-leaf' },
            { id: 'dan', name: 'Dan Aykroyd', desc: 'A famous actor who loves ghosts and law enforcement. His specific interests helped him write the movie Ghostbusters!', cost: 300, icon: 'fas fa-ghost' },
            { id: 'temple', name: 'Temple Grandin', desc: 'She thinks in pictures, not words. This unique way of seeing helps her design better systems for animals.', cost: 300, icon: 'fas fa-cow' }
        ];

        // Levels Configuration
        const levels = [
            { id: 1, title: 'Greetings', icon: 'fa-hand-sparkles', desc: 'Saying hello and goodbye.' },
            { id: 2, title: 'Conversation', icon: 'fa-comments', desc: 'Taking turns and listening.' },
            { id: 3, title: 'Personal Space', icon: 'fa-user-shield', desc: 'Keeping comfortable distances.' },
            { id: 4, title: 'Eating', icon: 'fa-utensils', desc: 'Table manners and sharing.' },
            { id: 5, title: 'Public Places', icon: 'fa-building', desc: 'How to act in libraries vs parks.' }
        ];

        // Question Bank (Subset of 128 - Scaled down for file size but structured to handle more)
        // Format: Level, Question, Correct Index, Feedback, Context Tip
        const questionBank = [
            // Level 1: Greetings
            { id: 101, lvl: 1, q: "You see your teacher at the supermarket. What do you do?", 
              opts: ["Hide behind the cereal.", "Run up and hug them tight.", "Smile, wave, and say 'Hello'.", "Stare at them until they see you."], 
              ans: 2, why: "A smile and wave is a friendly, polite way to acknowledge someone outside of school.", ctx: "Teachers have personal lives too. A quick hello is perfect." },
            { id: 102, lvl: 1, q: "Someone holds the door open for you. You should:", 
              opts: ["Walk through silently.", "Say 'Thank you'.", "Tell them they are doing it wrong.", "Stop and dance."], 
              ans: 1, why: "Saying thank you acknowledges their kindness.", ctx: "Small words like 'thanks' make people feel appreciated." },
            { id: 103, lvl: 1, q: "You are meeting a new friend's parent. They extend their hand.", 
              opts: ["Shake it firmly but gently.", "Slap it away.", "Tickle their palm.", "Look at the floor."], 
              ans: 0, why: "A handshake is a standard formal greeting in many places.", ctx: "Consent matters: if you don't like touch, a wave is okay too!" },
            { id: 104, lvl: 1, q: "Your friend is crying. What is a good first step?", 
              opts: ["Laugh at them.", "Ask 'Are you okay?'", "Walk away immediately.", "Tell them to be quiet."], 
              ans: 1, why: "Checking in shows empathy and care.", ctx: "Sometimes people want space, but asking first is kind." },
             
            // Level 2: Conversation
            { id: 201, lvl: 2, q: "Your friend is talking about their holiday. You want to talk about your video game.", 
              opts: ["Interrupt and talk about the game.", "Wait for a pause, acknowledge their story, then switch topics.", "Cover your ears.", "Walk away."], 
              ans: 1, why: "Conversations are like tennis; you have to hit the ball back and forth.", ctx: "Listening is just as important as talking." },
            { id: 202, lvl: 2, q: "Someone asks 'How are you?' What is a standard reply?", 
              opts: ["'Good thanks, and you?'", "A 20-minute story about your toe.", "'Why do you want to know?'", "Silence."], 
              ans: 0, why: "This is usually a 'phatic' expression - a social glue, not a deep question.", ctx: "Keep it short unless you know them very well." },
            
            // Level 3: Personal Space & Consent
            { id: 301, lvl: 3, q: "You want to hug your friend. What should you do first?", 
              opts: ["Run and tackle them.", "Ask 'Can I give you a hug?'", "Grab their arm.", "Hug them from behind."], 
              ans: 1, why: "Consent is key! Not everyone likes to be touched all the time.", ctx: "Even best friends have days where they don't want hugs." },
            { id: 302, lvl: 3, q: "You are standing in line. How close should you stand to the person in front?", 
              opts: ["Touching their back.", "Arm's length away.", "So far you can't see them.", "Breathing on their neck."], 
              ans: 1, why: "Arm's length is usually a comfortable 'personal bubble'.", ctx: "This bubble might get bigger or smaller depending on the country!" },

            // Level 4: Eating
            { id: 401, lvl: 4, q: "You don't like the dinner served at a friend's house. You say:", 
              opts: ["'This is disgusting!'", "'No thank you, I'm not hungry.'", "Spit it out.", "Throw it."], 
              ans: 1, why: "Polite refusal protects the host's feelings.", ctx: "Honesty is good, but kindness is better in this moment." },
            { id: 402, lvl: 4, q: "You need to burp at the dinner table.", 
              opts: ["Burp as loud as you can.", "Burp quietly and say 'Excuse me'.", "Burp in your neighbor's face.", "Laugh loudly."], 
              ans: 1, why: "Bodily functions happen, but we try to minimize them while eating.", ctx: "Saying 'excuse me' repairs the small social breach." },

            // Level 5: Public Places
            { id: 501, lvl: 5, q: "You are in a library. You see something funny on your phone.", 
              opts: ["Laugh loudly.", "Show everyone.", "Laugh quietly to yourself.", "Scream."], 
              ans: 2, why: "Libraries are shared quiet spaces.", ctx: "Different places have different volume rules." },
            { id: 502, lvl: 5, q: "You are at a rock concert. The music is loud.", 
              opts: ["Shh everyone.", "Cheer and clap.", "Sit in silence.", "Read a book."], 
              ans: 1, why: "At a concert, loud expression is the norm!", ctx: "Context changes everything. Screaming at a concert = Good. Screaming in class = Bad." }
        ];
        
        // Add more variations to simulate 128 scenarios if needed, but the logic handles reuse.

        /* --- STATE MANAGEMENT --- */
        
        let state = {
            coins: 0,
            gems: 0,
            lives: 3,
            streak: 0,
            lastLogin: null,
            maxLevel: 1,
            unlockedTheorists: [],
            unlockedPeople: [],
            diary: [], // { id, applied: false }
            wrongQueue: [], // IDs of questions got wrong
            theme: 'theme-blue'
        };

        // Load State
        function loadState() {
            const saved = localStorage.getItem('sociocoolState');
            if (saved) {
                state = { ...state, ...JSON.parse(saved) };
            }
            
            // Daily Streak Logic
            const today = new Date().toDateString();
            if (state.lastLogin !== today) {
                if (state.lastLogin) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    if (state.lastLogin === yesterday.toDateString()) {
                        state.streak++;
                    } else {
                        // Logic for streak freeze could go here
                        state.streak = 1;
                    }
                } else {
                    state.streak = 1;
                }
                state.lastLogin = today;
                saveState();
            }
            updateHUD();
            applyTheme(state.theme);
        }

        function saveState() {
            localStorage.setItem('sociocoolState', JSON.stringify(state));
            updateHUD();
        }

        function updateHUD() {
            document.getElementById('livesDisplay').innerText = state.lives;
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('gemsDisplay').innerText = state.gems;
            document.getElementById('streakDisplay').innerText = state.streak;
        }

        /* --- UI LOGIC --- */

        function applyTheme(themeName) {
            document.body.className = `${themeName} bg-[var(--bg-secondary)] text-gray-800 transition-colors duration-500`;
            state.theme = themeName;
            saveState();
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('text-[var(--bg-primary)]'));
            
            // Highlight active nav
            if(screenId === 'screen-map') document.querySelector('.nav-btn:nth-child(1)').classList.add('text-[var(--bg-primary)]');
            if(screenId === 'screen-library') {
                document.querySelector('.nav-btn:nth-child(2)').classList.add('text-[var(--bg-primary)]');
                renderLibrary();
            }
            if(screenId === 'screen-diary') {
                document.querySelector('.nav-btn:nth-child(3)').classList.add('text-[var(--bg-primary)]');
                renderDiary();
            }
            if(screenId === 'screen-shop') {
                document.querySelector('.nav-btn:nth-child(4)').classList.add('text-[var(--bg-primary)]');
                renderShop();
            }

            if (screenId === 'screen-map') renderMap();
        }

        function toggleMenu() {
            // Simple logic to reset for demo purposes
            if(confirm("Reset progress?")) {
                localStorage.removeItem('sociocoolState');
                location.reload();
            }
        }

        /* --- MAP LOGIC --- */

        function renderMap() {
            const mapEl = document.getElementById('levelMap');
            mapEl.innerHTML = '';
            
            levels.forEach((lvl, index) => {
                const isLocked = lvl.id > state.maxLevel;
                const isCurrent = lvl.id === state.maxLevel;
                
                const node = document.createElement('div');
                node.className = `level-node w-full max-w-xs relative ${isLocked ? 'locked' : ''}`;
                node.innerHTML = `
                    <div onclick="startLevel(${lvl.id})" class="bg-white p-4 rounded-2xl shadow-md border-b-4 ${isCurrent ? 'border-[var(--bg-primary)] ring-4 ring-blue-100' : 'border-gray-200'} cursor-pointer flex items-center gap-4 transform transition hover:scale-105 active:scale-95">
                        <div class="w-12 h-12 rounded-full ${isLocked ? 'bg-gray-200' : 'bg-[var(--bg-primary)]'} text-white flex items-center justify-center text-xl shadow-sm">
                            <i class="fas ${isLocked ? 'fa-lock' : lvl.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-gray-700">Level ${lvl.id}: ${lvl.title}</div>
                            <div class="text-xs text-gray-500">${lvl.desc}</div>
                        </div>
                        ${!isLocked && index < state.maxLevel - 1 ? '<i class="fas fa-check-circle text-green-500"></i>' : ''}
                    </div>
                `;
                
                // Connector line logic visual only
                if (index < levels.length - 1) {
                    const line = document.createElement('div');
                    line.className = 'h-6 w-1 bg-gray-300 my-1';
                    mapEl.appendChild(node);
                    mapEl.appendChild(line);
                } else {
                    mapEl.appendChild(node);
                }
            });
        }

        /* --- QUIZ LOGIC --- */

        let currentLevelId = 0;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let roundScore = 0;

        function startLevel(lvlId) {
            if (state.lives <= 0) {
                alert("You need hearts to play! Buy some in the shop or wait.");
                return;
            }
            if (lvlId > state.maxLevel) return;

            currentLevelId = lvlId;
            
            // Filter questions for this level
            let levelQs = questionBank.filter(q => q.lvl === lvlId);
            
            // "Wrong Answers Appear More Often" Logic
            // Check if we have queued wrong questions for this level
            const wrongForLevel = state.wrongQueue.filter(id => {
                const q = questionBank.find(qb => qb.id === id);
                return q && q.lvl === lvlId;
            });

            // Mix fresh questions and wrong questions
            // We want a round of 5 questions
            let roundQs = [];
            
            // 1. Add up to 2 review questions
            wrongForLevel.slice(0, 2).forEach(id => {
                roundQs.push(questionBank.find(q => q.id === id));
            });

            // 2. Fill the rest with random questions from the level
            const remainingCount = 5 - roundQs.length;
            const shuffled = levelQs.sort(() => 0.5 - Math.random());
            
            for(let q of shuffled) {
                if(roundQs.length < 5 && !roundQs.some(existing => existing.id === q.id)) {
                    roundQs.push(q);
                }
            }

            currentQuestions = roundQs;
            currentQuestionIndex = 0;
            roundScore = 0;
            
            showScreen('screen-quiz');
            renderQuestion();
        }

        function renderQuestion() {
            // Reset UI
            document.getElementById('btn-5050').classList.remove('opacity-50', 'pointer-events-none');
            document.getElementById('btn-skip').classList.remove('opacity-50', 'pointer-events-none');
            
            const q = currentQuestions[currentQuestionIndex];
            document.getElementById('levelProgress').innerText = `Question ${currentQuestionIndex + 1}/${currentQuestions.length}`;
            document.getElementById('questionText').innerText = q.q;
            document.getElementById('questionTag').innerText = levels.find(l => l.id === q.lvl).title;

            const optsDiv = document.getElementById('optionsContainer');
            optsDiv.innerHTML = '';

            q.opts.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = `opt-btn w-full text-left p-4 rounded-xl border-2 border-gray-100 bg-white hover:bg-gray-50 font-semibold text-gray-700 transition relative btn-bounce`;
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(idx);
                btn.id = `opt-${idx}`;
                optsDiv.appendChild(btn);
            });
        }

        function handleAnswer(selectedIndex) {
            const q = currentQuestions[currentQuestionIndex];
            const isCorrect = selectedIndex === q.ans;
            const feedbackModal = document.getElementById('feedbackModal');
            const icon = document.getElementById('feedbackIcon');
            const title = document.getElementById('feedbackTitle');
            const text = document.getElementById('feedbackText');
            const ctx = document.getElementById('feedbackContext');

            // Disable buttons
            document.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);

            if (isCorrect) {
                // Visuals
                document.getElementById(`opt-${selectedIndex}`).classList.add('bg-green-100', 'border-green-500');
                icon.innerHTML = '<i class="fas fa-check"></i>';
                icon.className = "w-16 h-16 rounded-full mx-auto flex items-center justify-center text-3xl mb-4 shadow-lg bg-green-100 text-green-600";
                title.innerText = "That's Sociocool!";
                title.className = "text-2xl font-bold text-center mb-2 text-green-600";
                
                // Logic
                state.coins += 10;
                roundScore++;
                
                // Remove from wrong queue if it was there
                state.wrongQueue = state.wrongQueue.filter(id => id !== q.id);

                // Add to diary if not exists
                if(!state.diary.find(d => d.id === q.id)) {
                    state.diary.push({ id: q.id, applied: false });
                }

            } else {
                // Visuals
                document.getElementById(`opt-${selectedIndex}`).classList.add('bg-red-100', 'border-red-500');
                // Highlight correct one
                document.getElementById(`opt-${q.ans}`).classList.add('bg-green-100', 'border-green-500');
                
                icon.innerHTML = '<i class="fas fa-times"></i>';
                icon.className = "w-16 h-16 rounded-full mx-auto flex items-center justify-center text-3xl mb-4 shadow-lg bg-red-100 text-red-600";
                title.innerText = "Not quite...";
                title.className = "text-2xl font-bold text-center mb-2 text-red-600";

                // Logic
                state.lives = Math.max(0, state.lives - 1);
                
                // Add to wrong queue for future repetition
                if(!state.wrongQueue.includes(q.id)) {
                    state.wrongQueue.push(q.id);
                }
            }

            text.innerText = q.why;
            ctx.innerText = q.ctx;
            saveState();
            
            // Delay modal slightly for visual effect
            setTimeout(() => {
                feedbackModal.classList.remove('hidden');
            }, 500);
        }

        function nextQuestion() {
            document.getElementById('feedbackModal').classList.add('hidden');
            
            if (state.lives <= 0) {
                showScreen('screen-map');
                return;
            }

            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuestions.length) {
                renderQuestion();
            } else {
                finishLevel();
            }
        }

        function finishLevel() {
            if (roundScore >= 3) { // Pass threshold
                createConfetti();
                
                // Unlock next level
                if (currentLevelId === state.maxLevel) {
                    state.maxLevel++;
                    
                    // Unlock Theorist associated with this level
                    const theorist = theorists.find(t => t.level === currentLevelId);
                    if (theorist && !state.unlockedTheorists.includes(theorist.id)) {
                        state.unlockedTheorists.push(theorist.id);
                        showUnlockModal(theorist);
                    }
                }
                alert(`Level Complete! You earned ${roundScore * 10} coins.`);
            } else {
                alert("Level Failed. Try again to progress!");
            }
            saveState();
            showScreen('screen-map');
        }

        function quitLevel() {
            if(confirm("Quit level? Progress will be lost.")) {
                showScreen('screen-map');
            }
        }

        /* --- LIFELINES --- */
        
        function useLifeline(type) {
            const q = currentQuestions[currentQuestionIndex];
            const btn = document.getElementById(`btn-${type}`);
            
            if (type === '5050') {
                if(state.coins < 50) return alert("Not enough coins!");
                state.coins -= 50;
                
                // Hide 2 wrong answers
                let removed = 0;
                q.opts.forEach((opt, idx) => {
                    if (idx !== q.ans && removed < 2) {
                        document.getElementById(`opt-${idx}`).style.visibility = 'hidden';
                        removed++;
                    }
                });
            } else if (type === 'skip') {
                if(state.coins < 100) return alert("Not enough coins!");
                state.coins -= 100;
                
                // Treat as correct but no points
                currentQuestionIndex++; // Logic to skip is tricky within flow, simpler to just auto-answer correct visually
                handleAnswer(q.ans); // This triggers correct logic, technically grants coins back, but keeps flow simple
                return; 
            }
            
            btn.classList.add('opacity-50', 'pointer-events-none');
            saveState();
        }

        /* --- LIBRARY LOGIC --- */

        function renderLibrary() {
            const theoContainer = document.getElementById('tab-theorists');
            const peopContainer = document.getElementById('tab-people');
            
            theoContainer.innerHTML = '';
            peopContainer.innerHTML = '';

            // Theorists
            theorists.forEach(t => {
                const isUnlocked = state.unlockedTheorists.includes(t.id);
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-xl shadow-sm border-2 ${isUnlocked ? 'border-[var(--bg-primary)]' : 'border-gray-200'} flex flex-col items-center text-center relative overflow-hidden`;
                
                if (!isUnlocked) {
                    card.innerHTML = `
                        <div class="absolute inset-0 bg-gray-100 z-10 flex flex-col items-center justify-center opacity-90">
                            <i class="fas fa-lock text-3xl text-gray-400 mb-2"></i>
                            <span class="text-xs text-gray-500 font-bold">Level ${t.level}</span>
                        </div>
                    `;
                }

                card.innerHTML += `
                    <div class="w-16 h-16 bg-gray-200 rounded-full mb-2 flex items-center justify-center text-2xl text-gray-400">
                         <i class="fas fa-user-graduate"></i>
                    </div>
                    <h4 class="font-bold text-sm">${t.name}</h4>
                    <span class="text-[10px] bg-orange-100 text-orange-600 px-2 rounded-full mb-2">${t.concept}</span>
                    <p class="text-[10px] text-gray-500 leading-tight">${t.desc}</p>
                `;
                theoContainer.appendChild(card);
            });

            // Cool People
            coolPeopleData.forEach(p => {
                const isOwned = state.unlockedPeople.includes(p.id);
                if(isOwned) {
                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-xl shadow-sm border-2 border-purple-400 flex flex-col items-center text-center";
                    card.innerHTML = `
                        <div class="w-16 h-16 bg-purple-100 rounded-full mb-2 flex items-center justify-center text-2xl text-purple-600">
                             <i class="${p.icon}"></i>
                        </div>
                        <h4 class="font-bold text-sm">${p.name}</h4>
                        <p class="text-[10px] text-gray-500 leading-tight mt-1">${p.desc}</p>
                    `;
                    peopContainer.appendChild(card);
                }
            });
            
            if(state.unlockedPeople.length === 0) {
                peopContainer.innerHTML = '<div class="col-span-2 text-center text-gray-400 text-sm py-8">Buy Cool People in the Shop!</div>';
            }
        }

        function switchLibraryTab(tab) {
            document.getElementById('tab-theorists').classList.add('hidden');
            document.getElementById('tab-people').classList.add('hidden');
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
        }

        /* --- SHOP LOGIC --- */

        function renderShop() {
            const container = document.getElementById('shopPeopleContainer');
            container.innerHTML = '';

            coolPeopleData.forEach(p => {
                const isOwned = state.unlockedPeople.includes(p.id);
                
                const item = document.createElement('div');
                item.className = "bg-white p-3 rounded-xl shadow-sm border flex justify-between items-center";
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="bg-gray-100 w-10 h-10 rounded-full flex items-center justify-center"><i class="${p.icon} text-gray-500"></i></div>
                        <div>
                            <div class="font-bold text-sm">${p.name}</div>
                            <div class="text-xs text-gray-500">Social Hero</div>
                        </div>
                    </div>
                `;

                const btn = document.createElement('button');
                if (isOwned) {
                    btn.className = "text-gray-400 text-xs font-bold px-3 py-1";
                    btn.innerText = "Owned";
                    btn.disabled = true;
                } else {
                    btn.className = "bg-purple-500 text-white px-3 py-1 rounded-lg font-bold text-sm shadow-sm btn-bounce";
                    btn.innerText = `${p.cost}ðŸ’Ž`;
                    btn.onclick = () => buyPerson(p.id, p.cost);
                }
                
                item.appendChild(btn);
                container.appendChild(item);
            });
        }

        function buyBooster(type, cost) {
            if(state.coins >= cost) {
                state.coins -= cost;
                if(type === 'life') state.lives++;
                if(type === 'freeze') alert("Streak Freeze activated! (Simulated)");
                saveState();
            } else {
                alert("Need more coins!");
            }
        }

        function buyTheme(themeName) {
            if(state.gems >= 20) {
                state.gems -= 20;
                applyTheme(themeName);
            } else {
                alert("Need 20 Gems!");
            }
        }

        function buyPerson(id, cost) {
            if(state.gems >= cost) {
                state.gems -= cost;
                state.unlockedPeople.push(id);
                alert("New person added to Library!");
                saveState();
                renderShop();
            } else {
                alert("Need more Gems!");
            }
        }

        /* --- DIARY LOGIC --- */

        function renderDiary() {
            const container = document.getElementById('diaryEntries');
            container.innerHTML = '';
            
            // Reverse so newest first
            const entries = [...state.diary].reverse();

            if(entries.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 mt-10">Play levels to fill your diary!</div>';
                return;
            }

            entries.forEach(entry => {
                const q = questionBank.find(x => x.id === entry.id);
                if(!q) return;

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-sm border-l-4 border-purple-400";
                
                let btnHtml = '';
                if(entry.applied) {
                    btnHtml = `<span class="text-xs font-bold text-green-500"><i class="fas fa-check"></i> Done IRL</span>`;
                } else {
                    btnHtml = `<button onclick="applyDiary('${entry.id}')" class="text-xs bg-purple-100 text-purple-600 px-3 py-1 rounded-full font-bold hover:bg-purple-200">I did this today!</button>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Norm #${entry.id}</span>
                        ${btnHtml}
                    </div>
                    <p class="font-bold text-gray-800 text-sm mb-1">"${q.q}"</p>
                    <p class="text-xs text-gray-500 italic">Solution: ${q.opts[q.ans]}</p>
                `;
                container.appendChild(card);
            });
        }

        function applyDiary(qid) {
            const entry = state.diary.find(d => d.id == qid); // loose equality for string/int mix safety
            if(entry && !entry.applied) {
                entry.applied = true;
                state.gems += 5;
                createConfetti();
                alert("+5 Gems for applying social skills in real life!");
                saveState();
                renderDiary();
            }
        }

        /* --- EXTRAS --- */

        function showUnlockModal(theorist) {
            const modal = document.getElementById('unlockModal');
            document.getElementById('unlockName').innerText = theorist.name;
            document.getElementById('unlockConcept').innerText = theorist.concept;
            document.getElementById('unlockDesc').innerText = theorist.desc;
            
            // Using fontawesome placeholder as images are restricted
            document.getElementById('unlockImage').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${theorist.name}`; 
            
            modal.classList.remove('hidden');
        }

        function closeUnlockModal() {
            document.getElementById('unlockModal').classList.add('hidden');
        }

        function createConfetti() {
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.backgroundColor = ['#f00', '#0f0', '#00f', '#ff0', '#0ff'][Math.floor(Math.random()*5)];
                c.style.animationDuration = (Math.random() * 2 + 1) + 's';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3000);
            }
        }

        // Initialize
        window.onload = loadState;

    </script>
</body>
</html>

